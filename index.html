<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>倒計時器（雙預設，免套用 | 全螢幕置中）</title>
  <meta name="description" content="雙組預設時間（A/B），直接載入欄位數值即套用，無需套用鍵；全螢幕置中，快捷鍵齊全。" />
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#22c55e; --accent-2:#3b82f6; --ring:rgba(59,130,246,.35);
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial;
      background: radial-gradient(1200px 800px at 80% -10%, #1f2937 0%, var(--bg) 60%);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      min-height:100vh;
    }
    .wrap{
      width:100%;
      max-width:720px;
      background:rgba(17,24,39,.65);
      backdrop-filter: blur(8px);
      border:1px solid rgba(148,163,184,.15);
      border-radius:16px;
      padding:20px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    header{ display:flex; flex-direction:column; gap:12px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .title{ font-weight:700; letter-spacing:.2px; font-size:18px; }
    .preset-row{
      display:grid; gap:10px; align-items:center;
      grid-template-columns: auto repeat(3, 80px) auto; /* 標籤 HH MM SS 載入 */
    }
    @media (max-width:560px){
      .preset-row{ grid-template-columns: auto repeat(3, 1fr); }
      .preset-row .load{ grid-column: 1 / -1; justify-self:start; }
    }
    .preset-row label{ font-size:12px; color:var(--muted); }
    .preset-row input{
      width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(148,163,184,.25);
      background:#0b1220; color:var(--text); outline:none; -moz-appearance: textfield;
    }
    .preset-row input::-webkit-outer-spin-button,.preset-row input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    .preset-row input:focus{ box-shadow:0 0 0 4px var(--ring); border-color:#3b82f640; }
    .screen{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:22px 16px; border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid rgba(148,163,184,.12);
    }
    .time{
      font-variant-numeric: tabular-nums; font-size:64px; font-weight:800; letter-spacing:2px;
      line-height:1; margin:12px 0 6px; user-select:none;
    }
    @media (max-width:420px){ .time{ font-size:48px; } }
    .hint{ font-size:12px; color:var(--muted); }
    .progress{ margin-top:16px; width:100%; height:8px; background:#0b1220; border-radius:999px; overflow:hidden; border:1px solid rgba(148,163,184,.18); }
    .bar{ height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); transition: width .2s ease; }
    .btns{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:18px; width:100%; }
    button{
      padding:10px 12px; border-radius:12px; border:1px solid transparent;
      background:#1f2937; color:var(--text); font-weight:700; letter-spacing:.2px; cursor:pointer;
      transition:.2s transform, .2s background, .2s border-color; outline:none; min-width:0;
    }
    button:active{ transform: translateY(1px) scale(.997); }
    .primary{ background: linear-gradient(180deg, #10b981, #059669); border-color:#0e9f6e; }
    .secondary{ background: linear-gradient(180deg, #3b82f6, #2563eb); border-color:#3b82f6; }
    .danger{ background: linear-gradient(180deg, #ef4444, #dc2626); border-color:#ef4444; }
    .ghost{ background:#111827; border-color:rgba(148,163,184,.25); }
    .blink{ animation: blink 1s step-end infinite; color:#fffbeb; text-shadow:0 0 8px rgba(245,158,11,.9); }
    @keyframes blink{ 50%{opacity:.3} }
    .small{ font-size:12px; color:var(--muted); }
    footer{ display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap; }

    /* 全螢幕置中：三列網格 */
    :fullscreen .wrap, .wrap:fullscreen{
      max-width:none; width:100%; height:100%;
      background:rgba(17,24,39,.7);
      display:grid;
      grid-template-rows: auto 1fr auto;
      justify-items:center;
      align-items:stretch;
      padding:24px;
      box-sizing:border-box;
      gap:16px;
    }
    :fullscreen header, .wrap:fullscreen header,
    :fullscreen footer, .wrap:fullscreen footer{
      width:100%;
      max-width:1200px;
    }
    :fullscreen .screen, .wrap:fullscreen .screen{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
    }
    :fullscreen .time, .wrap:fullscreen .time{
      font-size:min(16vw, 160px);
      letter-spacing:4px;
      margin:16px 0 8px;
    }
    :fullscreen .btns, .wrap:fullscreen .btns{ grid-template-columns: repeat(3, 1fr); gap:12px; }
    :fullscreen .btns button, .wrap:fullscreen .btns button{ padding:16px 18px; font-size:18px; }
  </style>
</head>
<body>
  <div class="wrap" id="container">
    <header>
      <div class="topbar">
        <div class="title">倒計時器（雙預設｜免套用）</div>
        <div class="top-buttons" style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="fs" class="ghost" title="全螢幕（F）">進入全螢幕</button>
        </div>
      </div>

      <!-- 預設 A -->
      <div class="preset-row" aria-label="預設 A">
        <label for="a-hh">預設 A</label>
        <input id="a-hh" type="number" min="0" step="1" value="0" aria-label="A 小時" />
        <input id="a-mm" type="number" min="0" max="59" step="1" value="5" aria-label="A 分鐘" />
        <input id="a-ss" type="number" min="0" max="59" step="1" value="0" aria-label="A 秒" />
        <button id="loadA" class="ghost load" title="將目前倒數重置為 A 欄位數值（L）">載入 A</button>
      </div>

      <!-- 預設 B -->
      <div class="preset-row" aria-label="預設 B">
        <label for="b-hh">預設 B</label>
        <input id="b-hh" type="number" min="0" step="1" value="0" aria-label="B 小時" />
        <input id="b-mm" type="number" min="0" max="59" step="1" value="1" aria-label="B 分鐘" />
        <input id="b-ss" type="number" min="0" max="59" step="1" value="30" aria-label="B 秒" />
        <button id="loadB" class="ghost load" title="將目前倒數重置為 B 欄位數值（K）">載入 B</button>
      </div>
    </header>

    <section class="screen" role="timer" aria-live="polite" aria-atomic="true">
      <div id="time" class="time">00:01:30</div>
      <div id="status" class="hint">已就緒</div>
      <div class="progress"><div id="bar" class="bar"></div></div>
      <div class="btns">
        <button id="start" class="primary">開始</button>
        <button id="pause" class="secondary">暫停</button>
        <button id="reset" class="danger">重置</button>
      </div>
    </section>

    <footer>
      <div class="small">
        鍵盤：Space 開始/暫停，R 重置，F 全螢幕，L 載入 A，K 載入 B
      </div>
      <div class="small">時間到播放 alarm.mp3（預設 3 次）。</div>
    </footer>
  </div>

  <audio id="bell" src="alarm.mp3" preload="auto"></audio>

  <script>
    // 目前使用中的預設時長（動態由載入 A/B 直接讀取輸入欄位）
    let presetMs = toMs({h:0,m:1,s:30});
    let remainingMs = presetMs;

    // 計時狀態
    let timerId = null;
    let lastTick = 0;
    let running = false;

    // 鈴聲播放設定（改為連續播放，不重疊）
    const chime = { times: 3, intervalMs: 300, volume: 1.0 };
    const bell = document.getElementById('bell'); bell.volume = chime.volume;

    // 元件
    const elTime = document.getElementById('time');
    const elStatus = document.getElementById('status');
    const elBar = document.getElementById('bar');
    const elStart = document.getElementById('start');
    const elPause = document.getElementById('pause');
    const elReset = document.getElementById('reset');
    // 預設欄位
    const aHH = document.getElementById('a-hh');
    const aMM = document.getElementById('a-mm');
    const aSS = document.getElementById('a-ss');
    const bHH = document.getElementById('b-hh');
    const bMM = document.getElementById('b-mm');
    const bSS = document.getElementById('b-ss');
    // 按鈕
    const btnLoadA = document.getElementById('loadA');
    const btnLoadB = document.getElementById('loadB');
    const elFs = document.getElementById('fs');
    const container = document.getElementById('container');

    // 初始畫面
    syncDisplay();
    updateFsButton();

    // 事件
    elStart.addEventListener('click', () => { unlockAudio(); start(); });
    elPause.addEventListener('click', pause);
    elReset.addEventListener('click', resetToPreset);
    btnLoadA.addEventListener('click', loadA);
    btnLoadB.addEventListener('click', loadB);
    elFs.addEventListener('click', toggleFullscreen);

    document.addEventListener('keydown', (e)=>{
      if (e.code === 'Space'){ e.preventDefault(); unlockAudio(); toggle(); }
      if (e.key === 'r' || e.key === 'R'){ e.preventDefault(); resetToPreset(); }
      if (e.key === 'f' || e.key === 'F'){ e.preventDefault(); toggleFullscreen(); }
      if (e.key === 'l' || e.key === 'L'){ e.preventDefault(); loadA(); }
      if (e.key === 'k' || e.key === 'K'){ e.preventDefault(); loadB(); }
    });
    ['fullscreenchange','webkitfullscreenchange','msfullscreenchange'].forEach(ev=>{
      document.addEventListener(ev, updateFsButton);
    });

    // 直接載入欄位數值（免套用）
    function loadA(){
      const ms = readInputsToMs(aHH, aMM, aSS);
      applyPreset(ms, '已載入 A');
    }
    function loadB(){
      const ms = readInputsToMs(bHH, bMM, bSS);
      applyPreset(ms, '已載入 B');
    }
    function readInputsToMs(hEl, mEl, sEl){
      const h = clampInt(hEl.value, 0, 99);
      const m = clampInt(mEl.value, 0, 59);
      const s = clampInt(sEl.value, 0, 59);
      hEl.value = h; mEl.value = m; sEl.value = s; // 回填規範值
      return toMs({h,m,s});
    }
    function applyPreset(ms, label){
      running = false; cancelAnimationFrame(timerId);
      presetMs = Math.max(0, ms);
      remainingMs = presetMs;
      syncDisplay();
      elStatus.textContent = label || '已載入預設';
    }

    // 主邏輯
    function start(){
      if (running) return;
      if (remainingMs <= 0) remainingMs = presetMs;
      running = true;
      lastTick = performance.now();
      elStatus.textContent = '計時中…';
      tick();
    }
    function pause(){
      if (!running) return;
      running = false;
      cancelAnimationFrame(timerId);
      elStatus.textContent = '已暫停';
    }
    function toggle(){ running ? pause() : start(); }
    function resetToPreset(){
      running = false;
      cancelAnimationFrame(timerId);
      remainingMs = presetMs;
      elStatus.textContent = '已重置至目前預設';
      syncDisplay();
    }
    function tick(){
      if (!running) return;
      const now = performance.now();
      const delta = now - lastTick;
      lastTick = now;
      remainingMs = Math.max(0, remainingMs - delta);
      syncDisplay();
      if (remainingMs <= 0){
        running = false;
        elStatus.textContent = '時間到！';
        elTime.classList.add('blink');
        notify();
        playChimeTimes(); // 連續播放，不重疊
        return;
      }
      timerId = requestAnimationFrame(tick);
    }
    function syncDisplay(){
      elTime.classList.toggle('blink', remainingMs <= 0);
      elTime.textContent = fmt(remainingMs);
      const base = Math.max(1, presetMs); // 避免除以 0
      const ratio = 1 - (remainingMs / base);
      elBar.style.width = `${Math.min(100, Math.max(0, ratio * 100))}%`;
    }

    // 多次播放音檔（連續播放，不重疊：每次播放結束後再播下一次）
    async function playChimeTimes(){
      try{
        // 預熱，避免首次播放被阻擋或無聲
        if (bell.readyState < 2){
          await bell.play().then(()=>bell.pause()).catch(()=>{});
          bell.currentTime = 0;
        }
        for (let i = 0; i < chime.times; i++){
          await new Promise(res=>{
            const a = bell.cloneNode(true);
            a.volume = bell.volume;
            a.addEventListener('ended', ()=>{ a.remove(); setTimeout(res, chime.intervalMs); });
            document.body.appendChild(a);
            a.play().catch(()=>res()); // 若播放被阻擋則直接繼續
          });
        }
      }catch(e){}
    }

    // 音訊解鎖
    let audioUnlocked = false;
    function unlockAudio(){
      if (audioUnlocked) return;
      try{
        const p = bell.play();
        if (p && typeof p.then === 'function'){
          p.then(()=>{ bell.pause(); bell.currentTime = 0; audioUnlocked = true; })
           .catch(()=>{});
        } else { audioUnlocked = true; }
      }catch(e){}
    }

    // 桌面通知
    async function notify(){
      try{
        if (!('Notification' in window)) return;
        if (Notification.permission === 'granted'){
          new Notification('倒計時結束', { body: '時間到！' });
        } else if (Notification.permission !== 'denied'){
          const p = await Notification.requestPermission();
          if (p === 'granted') new Notification('倒計時結束', { body: '時間到！' });
        }
      }catch(e){}
    }

    // 全螢幕控制
    function isFullscreen(){ return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement; }
    function requestFs(el){ if (el.requestFullscreen) return el.requestFullscreen(); if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen(); if (el.msRequestFullscreen) return el.msRequestFullscreen(); }
    function exitFs(){ if (document.exitFullscreen) return document.exitFullscreen(); if (document.webkitExitFullscreen) return document.webkitExitFullscreen(); if (document.msExitFullscreen) return document.msExitFullscreen(); }
    function toggleFullscreen(){ isFullscreen() ? exitFs() : requestFs(container); }
    function updateFsButton(){
      const fs = !!isFullscreen();
      elFs.textContent = fs ? '退出全螢幕' : '進入全螢幕';
      elFs.title = fs ? '退出全螢幕（F）' : '全螢幕（F）';
    }

    // 工具
    function toMs({h=0,m=0,s=0}){ return ((+h||0)*3600 + (+m||0)*60 + (+s||0)) * 1000; }
    function clampInt(v,min,max){ v = Math.floor(Math.abs(parseInt(v,10)||0)); return Math.max(min, Math.min(max, v)); }
    function fmt(ms){
      ms = Math.max(0, Math.floor(ms));
      const totalSec = Math.floor(ms/1000);
      const h = Math.floor(totalSec / 3600);
      const m = Math.floor((totalSec % 3600)/60);
      const s = totalSec % 60;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
  </script>
</body>
</html>
