<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>倒計時器（自選手機鬧鐘音檔）</title>
  <style>
    :root{ --bg:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --ring: rgba(59,130,246,.35); }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial;background:#0f172a;color:var(--text);display:flex;align-items:center;justify-content:center;padding:16px}
    .wrap{width:100%;max-width:700px;background:rgba(17,24,39,.6);backdrop-filter:blur(8px);border:1px solid rgba(148,163,184,.15);border-radius:16px;padding:20px}
    header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input,button{border-radius:10px;border:1px solid rgba(148,163,184,.25);background:#0b1220;color:var(--text);outline:none}
    input[type="number"]{padding:8px 10px;width:72px}
    input:focus,button:focus{box-shadow:0 0 0 4px var(--ring)}
    button{padding:10px 12px;cursor:pointer}
    .screen{display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px;border:1px solid rgba(148,163,184,.12);border-radius:14px}
    .time{font-variant-numeric:tabular-nums;font-weight:800;font-size:64px;letter-spacing:2px}
    .progress{width:100%;height:8px;background:#0b1220;border-radius:999px;overflow:hidden;border:1px solid rgba(148,163,184,.18)}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#3b82f6);transition:width .2s}
    .btns{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:100%}
    .hint{font-size:12px;color:var(--muted)}
    .blink{animation:blink 1s step-end infinite;color:#fffbeb;text-shadow:0 0 8px rgba(245,158,11,.9)}
    @keyframes blink{50%{opacity:.3}}
    .file-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .file-name{font-size:12px;color:var(--muted);max-width:320px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  </style>
</head>
<body>
  <div class="wrap" id="container">
    <header>
      <div class="row">
        <label>預設時間</label>
        <input id="hh" type="number" min="0" step="1" value="0" aria-label="小時" />
        <input id="mm" type="number" min="0" max="59" step="1" value="1" aria-label="分鐘" />
        <input id="ss" type="number" min="0" max="59" step="1" value="30" aria-label="秒" />
        <button id="apply">套用</button>
      </div>
      <div class="row">
        <button id="fs">全螢幕</button>
      </div>
    </header>

    <section class="screen" role="timer" aria-live="polite" aria-atomic="true">
      <div id="time" class="time">00:01:30</div>
      <div id="status" class="hint">已就緒</div>
      <div class="progress"><div id="bar" class="bar"></div></div>

      <div class="file-row">
        <input id="file" type="file" accept="audio/*,.m4a,.aac,.mp3,.wav,.ogg" />
        <span id="fileName" class="file-name">尚未選擇音檔</span>
        <button id="test">試播</button>
        <label style="display:flex;align-items:center;gap:6px">
          音量 <input id="vol" type="range" min="0" max="1" step="0.01" value="0.8" />
        </label>
        <label style="display:flex;align-items:center;gap:6px">
          循環 <input id="loop" type="checkbox" />
        </label>
      </div>

      <div class="btns">
        <button id="start">開始</button>
        <button id="pause">暫停</button>
        <button id="reset">重置</button>
      </div>
      <div class="hint">Space 開始/暫停，R 重置，F 全螢幕</div>
    </section>
  </div>

  <audio id="player" preload="auto" crossorigin="anonymous"></audio>

  <script>
    // 計時狀態
    let presetMs = toMs({h:0,m:1,s:30});
    let remainingMs = presetMs;
    let timerId = null, last = 0, running = false;

    // DOM
    const elTime = document.getElementById('time');
    const elBar = document.getElementById('bar');
    const elStatus = document.getElementById('status');
    const elHH = document.getElementById('hh');
    const elMM = document.getElementById('mm');
    const elSS = document.getElementById('ss');
    const elApply = document.getElementById('apply');
    const elStart = document.getElementById('start');
    const elPause = document.getElementById('pause');
    const elReset = document.getElementById('reset');
    const elFs = document.getElementById('fs');
    const container = document.getElementById('container');

    // 音檔
    const fileInput = document.getElementById('file');
    const fileName = document.getElementById('fileName');
    const player = document.getElementById('player');
    const testBtn = document.getElementById('test');
    const vol = document.getElementById('vol');
    const loop = document.getElementById('loop');

    // 初始化
    sync();
    player.volume = parseFloat(vol.value) || 0.8;

    // 事件
    elStart.onclick = start;
    elPause.onclick = pause;
    elReset.onclick = resetToPreset;
    elApply.onclick = applyPreset;
    elFs.onclick = toggleFullscreen;

    document.addEventListener('keydown', e=>{
      if (e.code==='Space'){ e.preventDefault(); running?pause():start(); }
      if (e.key==='r'||e.key==='R'){ e.preventDefault(); resetToPreset(); }
      if (e.key==='f'||e.key==='F'){ e.preventDefault(); toggleFullscreen(); }
    });

    fileInput.onchange = () => {
      const file = fileInput.files && fileInput.files[0];
      if (!file) { fileName.textContent = '尚未選擇音檔'; player.removeAttribute('src'); return; }
      const url = URL.createObjectURL(file);
      player.src = url;
      fileName.textContent = file.name;
      elStatus.textContent = '已載入音檔';
    };

    testBtn.onclick = () => {
      if (!player.src){ elStatus.textContent = '請先選擇音檔'; return; }
      safePlay();
    };

    vol.oninput = () => {
      player.volume = parseFloat(vol.value) || 0.8;
    };
    loop.onchange = () => {
      player.loop = loop.checked;
    };

    // 計時
    function start(){
      if (running) return;
      if (remainingMs<=0) remainingMs = presetMs;
      running = true; last = performance.now(); elStatus.textContent='計時中…'; tick();
    }
    function pause(){ if (!running) return; running=false; cancelAnimationFrame(timerId); elStatus.textContent='已暫停'; }
    function resetToPreset(){ running=false; cancelAnimationFrame(timerId); remainingMs=presetMs; elStatus.textContent='已重置至預設時間'; sync(); }
    function applyPreset(){
      const h=clamp(elHH.value,0,99), m=clamp(elMM.value,0,59), s=clamp(elSS.value,0,59);
      elHH.value=h; elMM.value=m; elSS.value=s;
      presetMs = toMs({h,m,s});
      if (!running){ remainingMs=presetMs; sync(); elStatus.textContent='已更新預設時間'; }
      else elStatus.textContent='已更新預設時間（重置後生效）';
    }
    function tick(){
      if (!running) return;
      const now = performance.now(), dt = now - last; last = now;
      remainingMs = Math.max(0, remainingMs - dt);
      sync();
      if (remainingMs<=0){
        running=false;
        elStatus.textContent='時間到！';
        elTime.classList.add('blink');
        notify();
        safePlay();
        return;
      }
      timerId = requestAnimationFrame(tick);
    }
    function sync(){
      elTime.textContent = fmt(remainingMs);
      const r = presetMs>0 ? 1-(remainingMs/presetMs):1;
      elBar.style.width = `${Math.min(100,Math.max(0,r*100))}%`;
      elTime.classList.toggle('blink', remainingMs<=0);
    }

    // 全螢幕
    function isFs(){ return document.fullscreenElement || document.webkitFullscreenElement; }
    function reqFs(el){ if (el.requestFullscreen) return el.requestFullscreen(); if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen(); }
    function exitFs(){ if (document.exitFullscreen) return document.exitFullscreen(); if (el.webkitExitFullscreen) return document.webkitExitFullscreen(); }
    function toggleFullscreen(){ isFs()?exitFs():reqFs(container); }

    // 工具
    function toMs({h=0,m=0,s=0}){ return ((+h||0)*3600+(+m||0)*60+(+s||0))*1000; }
    function clamp(v,min,max){ v=Math.floor(Math.abs(parseInt(v,10)||0)); return Math.max(min,Math.min(max,v)); }
    function fmt(ms){ ms=Math.max(0,Math.floor(ms)); const t=Math.floor(ms/1000), h=Math.floor(t/3600), m=Math.floor((t%3600)/60), s=t%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
    async function notify(){ try{ if('Notification'in window){ if(Notification.permission==='granted'){ new Notification('倒計時結束',{body:'時間到！'}); } else if(Notification.permission!=='denied'){ const p=await Notification.requestPermission(); if(p==='granted') new Notification('倒計時結束',{body:'時間到！'}); }}}catch(e){} }

    // 音訊播放（處理自動播放限制）
    async function safePlay(){
      try{
        // 部分瀏覽器需要使用者互動後才能播放
        const p = player.play();
        if (p && typeof p.then === 'function'){ await p; }
      }catch(err){
        elStatus.textContent = '自動播放被阻擋，請點擊「試播」或按播放按鈕';
      }
    }
  </script>
</body>
</html>
